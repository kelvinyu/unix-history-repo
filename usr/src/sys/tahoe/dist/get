#!/bin/sh -e
#
# Copyright (c) 1983 Regents of the University of California.
# All rights reserved.  The Berkeley software License Agreement
# specifies the terms and conditions for redistribution.
#
#	@(#)get	1.3 (Berkeley) %G%
#
# Shell script to build a mini-root file system
# in preparation for building a distribution tape.
# The file system created here is image copied onto
# tape, then image copied onto disk as the "first"
# step in a cold boot of 4.3 systems.
#
DISTROOT=/nbsd
#
if [ `pwd` = '/' ]
then
	echo You just '(almost)' destroyed the root
	exit
fi
cp $DISTROOT/sys/GENERIC/vmunix .
rm -rf bin; mkdir bin
rm -rf etc; mkdir etc
rm -rf a; mkdir a
rm -rf tmp; mkdir tmp
rm -rf stand; mkdir stand
cp $DISTROOT/etc/disklabel etc
cp $DISTROOT/etc/disktab etc
cp $DISTROOT/etc/newfs etc
cp $DISTROOT/etc/restore etc
cp $DISTROOT/etc/rrestore etc
cp $DISTROOT/etc/init etc
cp $DISTROOT/etc/mount etc
cp $DISTROOT/etc/mknod etc
cp $DISTROOT/etc/fsck etc
cp $DISTROOT/etc/umount etc
cp $DISTROOT/etc/ifconfig etc
cp $DISTROOT/bin/dd bin
cp $DISTROOT/bin/ed bin
cp $DISTROOT/bin/mt bin
cp $DISTROOT/bin/ls bin
cp $DISTROOT/bin/sh bin
cp $DISTROOT/bin/mv bin
cp $DISTROOT/bin/sync bin
cp $DISTROOT/bin/cat bin
cp $DISTROOT/bin/mkdir bin
cp $DISTROOT/bin/stty bin; ln bin/stty bin/STTY
cp $DISTROOT/bin/echo bin
cp $DISTROOT/bin/rm bin
cp $DISTROOT/bin/cp bin
cp $DISTROOT/bin/expr bin
cp $DISTROOT/bin/[ bin
cp $DISTROOT/bin/awk bin
cp $DISTROOT/bin/make bin
cp $DISTROOT/bin/rcp bin
cp $DISTROOT/stand/copy stand
cp $DISTROOT/stand/vdformat stand
cp $DISTROOT/boot .
cp $DISTROOT/wcs .
#cp $DISTROOT/fppwcs .
#cp $DISTROOT/poc .
#cp $DISTROOT/poc1 .
#cp $DISTROOT/poc2 .
#cp $DISTROOT/fppoc .
cp $DISTROOT/.profile .profile
cat >etc/passwd <<EOF
root::0:10::/:/bin/sh
EOF
cat >etc/group <<EOF
wheel:*:0:
staff:*:10:
EOF
cat >etc/fstab <<EOF
/dev/xfd0a:/a:xx:1:1
/dev/dk0a:/a:xx:1:1
EOF
cat >xtr <<'EOF'
#!/bin/sh -e
: ${disk?'Usage: disk=xx0 tape=yy xtr'}
: ${tape?'Usage: disk=xx0 tape=yy xtr'}
echo 'Build root file system'
newfs ${disk}a
sync
echo 'Check the file system'
fsck /dev/r${disk}a
mount /dev/${disk}a /a
cd /a
echo 'Rewind tape'
mt -f /dev/${tape}0 rew
echo 'Restore the dump image of the root'
restore rsf 3 /dev/${tape}0
cd /
sync
umount /dev/${disk}a
sync
fsck /dev/r${disk}a
echo 'Root filesystem extracted'
EOF
chmod +x xtr
rm -rf dev; mkdir dev
cp $DISTROOT/dev/MAKEDEV dev
chmod +x dev/MAKEDEV
cp /dev/null dev/MAKEDEV.local
cd dev
./MAKEDEV std dk0
./MAKEDEV cy0; mv rmt12 cy0; rm *mt*;
cd ..
sync
